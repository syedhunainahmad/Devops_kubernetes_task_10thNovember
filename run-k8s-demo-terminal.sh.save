#!/bin/bash

set -e

# -----------------------
# 1. Start Minikube
# -----------------------
echo "Starting Minikube..."
minikube delete --all || true
minikube start --driver=docker

# -----------------------
# 2. Use Minikube Docker
# -----------------------
echo "Switching Docker environment to Minikube..."
eval $(minikube docker-env)

# -----------------------
# 3. Build Docker images
# -----------------------
echo "Building backend image..."
docker build -t backend-image ./backend

echo "Building frontend image..."
docker build -t frontend-image ./frontend

# -----------------------
# 4. Create backend.yaml
# -----------------------
cat <<EOF > backend.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: backend
        image: backend-image
        ports:
        - containerPort: 5000
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend
  ports:
  - port: 5000
    targetPort: 5000
EOF

# -----------------------
# 5. Create frontend.yaml
# -----------------------
cat <<EOF > frontend.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: frontend
        image: frontend-image
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  type: NodePort
  selector:
    app: frontend
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
EOF

# -----------------------
# 6. Apply YAMLs
# -----------------------
echo "Applying backend and frontend deployments..."
kubectl apply -f backend.yaml
kubectl apply -f frontend.yaml

# -----------------------
# 7. Wait for pods to be ready
# -----------------------
echo "Waiting for backend pod to be ready..."
kubectl wait --for=condition=ready pod -l app=backend --timeout=120s

echo "Waiting for frontend pod to be ready..."
kubectl wait --for=condition=ready pod -l app=frontend --timeout=120s

# -----------------------
# 8. Show pods and services
# -----------------------
kubectl get pods
kubectl get svc

# -----------------------
# 9. Print frontend URL for terminal
# -----------------------
FRONTEND_URL="http://$(minikube ip):30080"
echo ""
echo "Frontend is now running! Access it via this URL in your browser or curl:"
echo "$FRONTEND_URL"
echo ""
echo "Example (terminal test): curl $FRONTEND_URL"


